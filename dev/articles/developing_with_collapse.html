<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developing with collapse • collapse</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Developing with collapse">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">collapse</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.0.18.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/rcollapse.bsky.social" aria-label="BlueSky"><span class="fa fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/collapse_R" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/collapse" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Developing with collapse</h1>
            <h3 data-toc-skip class="subtitle">Or: How to Code
Efficiently in R</h3>
                        <h4 data-toc-skip class="author">Sebastian
Krantz</h4>
            
            <h4 data-toc-skip class="date">2024-12-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/master/vignettes/developing_with_collapse.Rmd" class="external-link"><code>vignettes/developing_with_collapse.Rmd</code></a></small>
      <div class="d-none name"><code>developing_with_collapse.Rmd</code></div>
    </div>

    
    
<style type="text/css">
pre {
  max-height: 500px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>collapse</em> offers an integrated suite of C/C++-based
statistical and data manipulation functions, many low-level tools for
memory efficient programming, and a <a href="https://sebkrantz.github.io/collapse/articles/collapse_object_handling.html">class-agnostic
architecture</a> that seamlessly supports vectors, matrices, and
data.frame-like objects. These features make it an ideal backend for
high-performance statistical packages. This vignette is meant to provide
some recommendations for developing with <em>collapse</em>. It is
complementary to the earlier <a href="https://sebkrantz.github.io/Rblog/2020/09/13/programming-with-collapse/" class="external-link">blog
post on programming with <em>collapse</em></a> which readers are also
highly recommended to consult. The vignette adds 3 important points for
writing efficient R/<em>collapse</em> code.</p>
<p>But before I jump into those let me start with an important warning
which is that, while <em>collapse</em> is conveniently globally
configurable using the <code><a href="../reference/collapse-options.html">set_collapse()</a></code> function, this
function should NEVER be called in a package: These are global options
that will also affect <em>collapse</em>’s behavior outside of your
package.</p>
</div>
<div class="section level2">
<h2 id="point-1-be-minimalistic-regarding-computations">Point 1: Be Minimalistic Regarding Computations<a class="anchor" aria-label="anchor" href="#point-1-be-minimalistic-regarding-computations"></a>
</h2>
<p><em>collapse</em> supports different types of R objects (vectors,
matrices, data frames + variants) and it can perform grouped operations
on them using different types of grouping information (plain vector(s),
‘qG’<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Alias for quick-group.&lt;/p&gt;"><sup>1</sup></a>
objects, factors, ‘GRP’ objects, grouped or indexed data frames).
Grouping can be sorted or unsorted. A key for very efficient code is to
use the minimal required operations/objects to get the job done.</p>
<p>For example, suppose you have the simple task of summing an object
<code>x</code> by groups using a grouping vector <code>g</code>. If this
grouping is only needed once, it should be done using the internal
grouping of <code><a href="../reference/fsum.html">fsum()</a></code> without creating any external grouping
objects, e.g., <code>fsum(x, g)</code> for aggregation and
<code>fsum(x, g, TRA = "fill")</code> for expansion. The expansion case
is very efficient internally because it uses unsorted grouping. In
general, apart from the default sorted aggregation, these functions are
pretty smart in converting your vector input <code>g</code> into the
minimally required grouping information.</p>
<p>In the aggregation case, we can improve performance by also using
unsorted grouping, e.g., <code>fsum(x, qF(g, sort = FALSE))</code> or
<code>fsum(x, qG(g, sort = FALSE), use.g.names = FALSE)</code> if the
row-names are not needed. If it is known that <code>g</code> is a plain
vector or the first-appearance order of groups should be kept even if
<code>g</code> is a factor, use <code>group(g)</code> instead of
<code>qG(g, sort = FALSE)</code>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;code&gt;&lt;a href="../reference/group.html"&gt;group()&lt;/a&gt;&lt;/code&gt; directly calls a C-based hashing
algorithm which works for all types of vectors and lists of vectors/data
frames. Missing values are treated as distinct elements.&lt;/p&gt;'><sup>2</sup></a></p>
<p>If the same operation is needed on multiple vectors/objects, save the
factor/‘qG’ object and reuse it. If not using <code><a href="../reference/group.html">group()</a></code> to
create ‘qG’, add the argument <code>na.exclude = FALSE</code> to
<code>qF()/qG()</code> to add a class ‘na.included’ to the object which
precludes internal missing value checks in <code><a href="../reference/fsum.html">fsum()</a></code> and
friends. Always set <code>use.g.names = FALSE</code> if not needed, and,
if your data has no missing values, set <code>na.rm = FALSE</code> in
statistical functions like <code><a href="../reference/fsum.html">fsum()</a></code> for maximum
performance.</p>
<p>Overall, note that factors/‘qG’ are efficient inputs for computations
with all statistical/transformation functions except for
<code><a href="../reference/fnth_fmedian.html">fmedian()</a></code>, <code><a href="../reference/fnth_fmedian.html">fnth()</a></code>, <code><a href="../reference/fmode.html">fmode()</a></code>,
<code><a href="../reference/fndistinct.html">fndistinct()</a></code>, and split-apply-combine operations using
<code>BY()/gsplit()</code>.</p>
<p>For repeated grouped operations involving these latter functions, it
makes sense to create ‘GRP’ objects using <code>g = GRP(g)</code>. These
objects are more expensive to create but provide more complete
information - see <code><a href="../reference/GRP.html">?GRP</a></code>, in particular the ‘Value’ section.
If sorting is not needed, set <code>sort = FALSE</code>, and if
aggregation or the unique groups/group names are not needed set
<code>return.groups = FALSE</code>.</p>
<p>Only in rare cases where repeated operations on grouped data
frames/indexed panels are needed does it make sense to employ
<code><a href="../reference/GRP.html">fgroup_by()</a></code> or <code><a href="../reference/indexing.html">findex_by()</a></code> in package code.
Likewise, functions like <code>fsummarise()/fmutate()</code> are
essentially wrappers. For example</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fsummarise.html">fsummarise</a></span><span class="op">(</span>mpg <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="../reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">carb</span>, <span class="va">hp</span>, <span class="va">qsec</span><span class="op">)</span>, <span class="va">fmean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am   mpg     carb        hp     qsec</span></span>
<span><span class="co"># 1   4  0  1  26.0 2.000000  91.00000 16.70000</span></span>
<span><span class="co"># 2   4  1  0  68.7 1.666667  84.66667 20.97000</span></span>
<span><span class="co"># 3   4  1  1 198.6 1.428571  80.57143 18.70000</span></span>
<span><span class="co"># 4   6  0  1  61.7 4.666667 131.66667 16.32667</span></span>
<span><span class="co"># 5   6  1  0  76.5 2.500000 115.25000 19.21500</span></span>
<span><span class="co"># 6   8  0  0 180.6 3.083333 194.16667 17.14250</span></span>
<span><span class="co"># 7   8  0  1  30.8 6.000000 299.50000 14.55000</span></span></code></pre></div>
<p>Is the same as (<code>use = FALSE</code> abbreviates
<code>use.g.names = FALSE</code>)</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"vs"</span>, <span class="st">"am"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">$</span><span class="va">groups</span>,</span>
<span>  <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"mpg"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">g</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"carb"</span>, <span class="st">"hp"</span>, <span class="st">"qsec"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">g</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am   mpg     carb        hp     qsec</span></span>
<span><span class="co"># 1   4  0  1  26.0 2.000000  91.00000 16.70000</span></span>
<span><span class="co"># 2   4  1  0  68.7 1.666667  84.66667 20.97000</span></span>
<span><span class="co"># 3   4  1  1 198.6 1.428571  80.57143 18.70000</span></span>
<span><span class="co"># 4   6  0  1  61.7 4.666667 131.66667 16.32667</span></span>
<span><span class="co"># 5   6  1  0  76.5 2.500000 115.25000 19.21500</span></span>
<span><span class="co"># 6   8  0  0 180.6 3.083333 194.16667 17.14250</span></span>
<span><span class="co"># 7   8  0  1  30.8 6.000000 299.50000 14.55000</span></span></code></pre></div>
<p>Nothing prevents you from using these wrappers - they are quite
efficient - but if you want to change all inputs programmatically it
makes sense to go down one level.</p>
<p>In general, think carefully about how to vectorize expressions (using
<em>collapse</em> or auxiliary packages) in a minimalistic and memory
efficient way. You will find that you can craft very parsimonious and
efficient code to solve complicated problems.</p>
<p>For example, after merging multiple spatial datasets, I had some of
the same map features (businesses) from multiple sources, and, unwilling
to match features individually across data sources, I decided to keep
the richest source covering each feature type and location. After
creating a feature <code>importance</code> indicator comparable across
sources, the deduplication expression ended up being a single line of
the form:
<code>fsubset(data, source == fmode(source, list(location, type), importance, "fill"))</code>,
i.e., keep features from the importance-weighted mode (i.e., most
frequent) source by location and type.</p>
<p>If an effective <em>collapse</em> solution is not apparent, other
packages may offer efficient solutions. Check out the <a href="https://fastverse.github.io/fastverse/" class="external-link"><em>fastverse</em></a> and
its <a href="https://fastverse.github.io/fastverse/#suggested-extensions" class="external-link">suggested
packages list</a>. For example if you want to efficiently replace
multiple items in a vector, <code>kit::vswitch()/nswitch()</code> can be
pretty magical. Also functions like
<code>data.table::set()/rowid()</code> etc. are great, e.g., <a href="https://github.com/SebKrantz/collapse/issues/627" class="external-link">recent
issue</a>: what is the <em>collapse</em> equivalent to a grouped
<code>dplyr::slice_head(n)</code>? It would be
<code>fsubset(data, data.table::rowid(id1, id2, ...) &lt;= n)</code>.</p>
</div>
<div class="section level2">
<h2 id="point-2-think-about-memory-and-optimize">Point 2: Think About Memory and Optimize<a class="anchor" aria-label="anchor" href="#point-2-think-about-memory-and-optimize"></a>
</h2>
<p>R programs are inefficient for 2 principal reasons: (1) operations
are not vectorized; (2) too many intermediate objects/copies are
created. <em>collapse</em>’s vectorized statistical functions address
(1) effectively, but it also provides many <a href="https://sebkrantz.github.io/collapse/reference/efficient-programming.html">efficient
programming functions</a> to deal with (2).</p>
<p>One source of inefficiency in R code is the widespread use of logical
vectors. For example</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>where <code>x == 0</code> creates a logical vector of 1 million
elements just to indicate to R which elements of <code>x</code> are
<code>0</code>. In <em>collapse</em>, <code>setv(x, 0, NA)</code> is the
efficient equivalent. This also works if we don’t want to replace with
<code>NA</code> but with another vector y, e.g.,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/efficient-programming.html">setv</a></span><span class="op">(</span><span class="va">x</span>, <span class="cn">NA</span>, <span class="va">y</span><span class="op">)</span> <span class="co"># Replaces missing x with y</span></span></code></pre></div>
<p>is much better than</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p><code><a href="../reference/efficient-programming.html">setv()</a></code> is quite versatile and also works with indices
and logical vectors instead of elements to search for, and it can invert
the query setting <code>invert = TRUE</code>.</p>
<p>In more complex workflows, we may want to save the logical vector,
e.g. <code>xmiss &lt;- is.na(x)</code> and use it repeatedly. One aspect
to note here is the logical vectors are inefficient for subsetting
compared to indices:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xNA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efficient-programming.html">na_insert</a></span><span class="op">(</span><span class="va">x</span>, prop <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">xmiss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">xNA</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">xmiss</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">xmiss</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 2 × 6</span></span>
<span><span class="co">#   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co"># 1 x[xmiss]      3.3ms   3.59ms      270.    8.39MB     4.35</span></span>
<span><span class="co"># 2 x[ind]      780.6µs 978.01µs     1015.    3.05MB     4.36</span></span></code></pre></div>
<p>Thus, indices are always preferable. With <em>collapse</em>, they can
be created directly using <code>whichNA(xNA)</code> in this case, or
using <code>whichv(x, 0)</code> for <code>which(x == 0)</code> or any
other number. Also here there exist an <code>invert = TRUE</code>
argument covering the <code>!=</code> case. For convenience, infix
operators <code>x %==% 0</code> and <code>x %!=% 0</code> wrap
<code>whichv(x, 0)</code> and <code>whichv(x, 0, invert = TRUE)</code>,
respectively.</p>
<p>Similarly, the function <code><a href="../reference/fmatch.html">fmatch()</a></code> supports faster
matching with associated operators <code>%iin%</code> and
<code>%!iin%</code> which also return indices, e.g.,
<code>letters %iin% c("a", "b")</code> returns <code>1:2</code>. This
can also be used in subsetting:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span></span>
<span>  `%in%` <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">iso3c</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USA"</span>, <span class="st">"DEU"</span>, <span class="st">"ITA"</span>, <span class="st">"GBR"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  `%iin%` <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">iso3c</span> <span class="op"><a href="../reference/fmatch.html">%iin%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USA"</span>, <span class="st">"DEU"</span>, <span class="st">"ITA"</span>, <span class="st">"GBR"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 2 × 6</span></span>
<span><span class="co">#   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co"># 1 %in%        142.8µs    161µs     6152.     3.8MB     4.45</span></span>
<span><span class="co"># 2 %iin%        16.8µs   22.2µs    43963.   130.4KB     8.79</span></span></code></pre></div>
<p>Likewise, <code>anyNA(), allNA(), anyv()</code> and
<code><a href="../reference/efficient-programming.html">allv()</a></code> help avoid expressions like <code>any(x == 0)</code>
in favor of <code>anyv(x, 0)</code>. Other convenience functions exist
such as <code>na_rm(x)</code> for the common <code>x[!is.na(x)]</code>
expression which is extremely inefficient.</p>
<p>Another hint here particularly for data frame subsetting is the
<code><a href="../reference/fsubset.html">ss()</a></code> function, which has an argument
<code>check = FALSE</code> to avoid checks on indices (small effect with
this data size):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span> <span class="op"><a href="../reference/fmatch.html">%!iin%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USA"</span>, <span class="st">"DEU"</span>, <span class="st">"ITA"</span>, <span class="st">"GBR"</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  withcheck <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">ind</span><span class="op">)</span>,</span>
<span>  nocheck <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">ind</span>, check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#       expr    min      lq     mean   median       uq     max neval</span></span>
<span><span class="co">#  withcheck 60.680 102.049 105.3921 105.4930 110.2285 124.968   100</span></span>
<span><span class="co">#    nocheck 52.685 100.033 103.5491 102.6615 107.3355 120.222   100</span></span></code></pre></div>
<p>Another common source of inefficiencies is copies produces in
statistical operations. For example</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>; <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>; <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="va">z</span> <span class="co"># Creates 2 copies</span></span></code></pre></div>
<p>For this particular case <code>res &lt;- kit::psum(x, y, z)</code>
offers a direct efficient solution<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In general, also see other packages, in particular
&lt;em&gt;kit&lt;/em&gt; and &lt;em&gt;data.table&lt;/em&gt; for useful programming functions.&lt;/p&gt;"><sup>3</sup></a>. A more general solution is</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span><span class="va">res</span> <span class="op"><a href="../reference/efficient-programming.html">%+=%</a></span> <span class="va">z</span></span></code></pre></div>
<p><em>collapse</em>’s <code>%+=%</code>, <code>%-=%</code>,
<code>%*=%</code> and <code>%/=%</code> operators are wrappers around
the <code><a href="../reference/efficient-programming.html">setop()</a></code> function which also works with matrices and
data frames.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;&lt;em&gt;Note&lt;/em&gt; that infix operators do not obey the rules
of arithmetic but are always evaluated from left to right.&lt;/p&gt;"><sup>4</sup></a> This function also supports a
<code>rowwise</code> argument for operations between vectors and
matrix/data.frame rows, e.g.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/efficient-programming.html">setop</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"*"</span>, <span class="fu"><a href="../reference/efficient-programming.html">seq_col</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, rowwise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">m</span> <span class="op">/</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                   mpg cyl disp hp drat wt qsec  vs  am gear carb</span></span>
<span><span class="co"># Mazda RX4           1   2    3  4    5  6    7 NaN   9   10   11</span></span>
<span><span class="co"># Mazda RX4 Wag       1   2    3  4    5  6    7 NaN   9   10   11</span></span>
<span><span class="co"># Datsun 710          1   2    3  4    5  6    7   8   9   10   11</span></span>
<span><span class="co"># Hornet 4 Drive      1   2    3  4    5  6    7   8 NaN   10   11</span></span>
<span><span class="co"># Hornet Sportabout   1   2    3  4    5  6    7 NaN NaN   10   11</span></span>
<span><span class="co"># Valiant             1   2    3  4    5  6    7   8 NaN   10   11</span></span></code></pre></div>
<p>Some functions like <code>na_locf()/na_focb()</code> also have
<code>set = TRUE</code> arguments to perform operations by reference.
There is also the function <code><a href="../reference/TRA.html">setTRA()</a></code> for (grouped)
transformations by reference, which wraps
<code>TRA(..., set = TRUE)</code>. Since <code>TRA</code> is added as an
argument to all <a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html"><em>Fast
Statistical Functions</em></a>, <code>set = TRUE</code> can be passed
down to modify by reference. For example:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, TRA <span class="op">=</span> <span class="st">"fill"</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Is the same as
<code>setTRA(iris$Sepal.Length, fmedian(iris$Sepal.Length, iris$Species), "fill", iris$Species)</code>,
replacing the values of the <code>Sepal.Length</code> vector with its
species median by reference:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="co">#   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co"># 1            5         3.5          1.4         0.2  setosa</span></span>
<span><span class="co"># 2            5         3.0          1.4         0.2  setosa</span></span>
<span><span class="co"># 3            5         3.2          1.3         0.2  setosa</span></span>
<span><span class="co"># 4            5         3.1          1.5         0.2  setosa</span></span>
<span><span class="co"># 5            5         3.6          1.4         0.2  setosa</span></span>
<span><span class="co"># 6            5         3.9          1.7         0.4  setosa</span></span></code></pre></div>
<p>This <code>set</code> argument can be invoked anywhere, also inside
<code><a href="../reference/ftransform.html">fmutate()</a></code> calls with/without groups. This can also be done
in combination with other transformations (sweeping operations). For
example the following turns the columns of the matrix into
proportions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">m</span>, TRA <span class="op">=</span> <span class="st">"/"</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="co"># Check</span></span>
<span><span class="co">#  mpg  cyl disp   hp drat   wt qsec   vs   am gear carb </span></span>
<span><span class="co">#    1    1    1    1    1    1    1    1    1    1    1</span></span></code></pre></div>
<p>In summary, think what is really needed to complete a task and keep
things to a minimum in terms of both computations and memory. Let’s do a
final exercise in this regard and create a hyper-efficient function for
univariate linear regression by groups:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">greg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, <span class="va">g</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span>  <span class="va">dmx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">g</span>, TRA <span class="op">=</span> <span class="st">"-"</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">(</span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">g</span>, <span class="va">dmx</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/efficient-programming.html">%/=%</a></span></span>
<span>   <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">dmx</span>, <span class="va">g</span>, <span class="va">dmx</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Test</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="fl">1e7</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu">greg</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, <span class="va">g</span><span class="op">)</span>, <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: milliseconds</span></span>
<span><span class="co">#           expr       min        lq     mean    median        uq      max neval</span></span>
<span><span class="co">#  greg(y, x, g) 128.22237 132.78080 158.3952 143.83729 156.82039 324.2716   100</span></span>
<span><span class="co">#       group(g)  59.37759  62.23669  67.8692  64.45758  70.68847 161.5587   100</span></span></code></pre></div>
<p>The expression computed by <code>greg()</code> amounts to
<code>sum(y * (x - mean(x)))/sum((x - mean(x))^2)</code> for each group,
which is equivalent to <code>cov(x, y)/var(x)</code>, but very
efficient, requiring exactly one full copy of <code>x</code> to create a
group-demeaned vector, <code>dmx</code>, and then using the
<code>w</code> (weights) argument to <code><a href="../reference/fsum.html">fsum()</a></code> to sum the
products (<code>y * dmx</code> and <code>dmx * dmx</code>) on the fly,
including a division by reference avoiding an additional copy. One
cannot do much better coding a grouped regression directly in C, and
ostensibly the grouping step already accounts for half of the computing
time.</p>
</div>
<div class="section level2">
<h2 id="point-3-internally-favor-primitive-r-objects-and-functions">Point 3: Internally Favor Primitive R Objects and Functions<a class="anchor" aria-label="anchor" href="#point-3-internally-favor-primitive-r-objects-and-functions"></a>
</h2>
<p>This partly reiterates Point 1 but now with a focus on internal data
representation rather than grouping and computations. The point could
also be bluntly stated as: ‘vectors, matrices and lists are good, data
frames and complex objects are bad’.</p>
<p>Many frameworks seem to imply the opposite, e.g., the
<em>tidyverse</em> encourages you to cast your data as a tidy tibble,
and also <em>data.table</em> offers you a more efficient data frame. But
these objects are internally complex, and, in the case of
<em>data.table</em>, only efficient because of the internal C-level
algorithms for large-data manipulation. You should always take a step
back to ask yourself: For the statistical software I am writing, do I
need this complexity? Complex objects require complex methods to
manipulate them, thus, when using them, you incur the cost of everything
that goes on in these methods. Vectors, matrices, and lists are much
more efficient in R and <em>collapse</em> provides you with many options
to manipulate them directly.</p>
<p>It may surprise you to hear that, internally, <em>collapse</em> does
not use data frame-like objects at all. Instead, such objects are cast
to lists using <code><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass()</a></code>,
<code>class(data) &lt;- NULL</code>, or
<code>attributes(data) &lt;- NULL</code> and code is written to do
specific things on that list. This is advisable if you want to write
fast package code for data frame-like objects. Of course there are
limits, e.g., for advanced manipulations such as <code><a href="../reference/join.html">join()</a></code> or
<code><a href="../reference/pivot.html">pivot()</a></code>, but many tasks can be solved using simpler
objects. If you don’t want to internally convert data frames to lists,
use functions <code><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset()</a></code> and <code><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset2()</a></code> to
efficiently extract columns and <code><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr()</a></code> to extract/set
attributes. With matrices use <code><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames()</a></code> directly instead
of <code><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames()</a></code> and <code><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames()</a></code>, which are
wrappers around it.</p>
<p>The benchmark below illustrates that basically everything you do on
the data.frame is more expensive than on the equivalent list.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">nam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"names"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nam</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"names"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nam</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nam</span>,</span>
<span>               <span class="va">mtcars</span><span class="op">[[</span><span class="st">"mpg"</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset2</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"mpg"</span><span class="op">)</span>, <span class="va">l</span><span class="op">[[</span><span class="st">"mpg"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>               <span class="va">mtcars</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span>, <span class="va">l</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset2</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: nanoseconds</span></span>
<span><span class="co">#                          expr  min     lq    mean median     uq   max neval</span></span>
<span><span class="co">#                 names(mtcars)  164  205.0  236.57  246.0  246.0   410   100</span></span>
<span><span class="co">#         attr(mtcars, "names")   41   82.0  105.78   82.0  123.0   902   100</span></span>
<span><span class="co">#                      names(l)    0    0.0   32.80   41.0   41.0   328   100</span></span>
<span><span class="co">#          names(mtcars) &lt;- nam  410  492.0  672.81  594.5  656.0  8856   100</span></span>
<span><span class="co">#  attr(mtcars, "names") &lt;- nam  287  348.5  447.31  451.0  492.0  1394   100</span></span>
<span><span class="co">#               names(l) &lt;- nam  205  205.0  257.89  246.0  246.0  1271   100</span></span>
<span><span class="co">#               mtcars[["mpg"]] 1968 2091.0 2251.31 2173.0 2337.0  5453   100</span></span>
<span><span class="co">#       .subset2(mtcars, "mpg")    0   41.0   72.16   82.0   82.0   779   100</span></span>
<span><span class="co">#                    l[["mpg"]]   41   41.0   80.36   82.0   82.0   287   100</span></span>
<span><span class="co">#                   mtcars[3:8] 5207 5371.0 5860.54 5453.0 5637.5 22509   100</span></span>
<span><span class="co">#          .subset(mtcars, 3:8)  205  287.0  296.02  287.0  287.0   615   100</span></span>
<span><span class="co">#                        l[3:8]  246  287.0  318.98  287.0  328.0   533   100</span></span>
<span><span class="co">#                  ncol(mtcars) 1025 1107.0 1247.22 1189.0 1271.0  5863   100</span></span>
<span><span class="co">#                length(mtcars)  164  205.0  262.40  246.0  287.0   574   100</span></span>
<span><span class="co">#       length(unclass(mtcars))  123  164.0  179.58  164.0  205.0   492   100</span></span>
<span><span class="co">#                     length(l)    0    0.0   18.86    0.0   41.0    82   100</span></span>
<span><span class="co">#                  nrow(mtcars) 1025 1107.0 1330.04 1148.0 1230.0 15744   100</span></span>
<span><span class="co">#  length(.subset2(mtcars, 1L))   41   82.0  104.55   82.0  123.0   369   100</span></span>
<span><span class="co">#               length(l[[1L]])   41   82.0   98.40   82.0  123.0   328   100</span></span></code></pre></div>
<p>By means of further illustration, let’s recreate the
<code><a href="../reference/pwcor_pwcov_pwnobs.html">pwnobs()</a></code> function in <em>collapse</em> which counts
pairwise missing values. The list method is written in R. A basic
implementation would be:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;By Point 2 this implementation is not ideal because I am
creating two logical vectors for each iteration of the inner loop, but I
currently don’t see any way to write this more efficiently.&lt;/p&gt;"><sup>5</sup></a></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwnobs_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fnobs.html">fnobs</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">nr</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">miss</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">N.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">N.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcNA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efficient-programming.html">na_insert</a></span><span class="op">(</span><span class="va">mtcars</span>, prop <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu">pwnobs_list</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span></span>
<span><span class="co">#      mpg cyl disp hp drat wt qsec vs am gear carb</span></span>
<span><span class="co"># mpg   26  22   22 22   21 21   20 22 21   20   20</span></span>
<span><span class="co"># cyl   22  26   21 21   22 22   22 20 20   23   21</span></span>
<span><span class="co"># disp  22  21   26 20   21 20   20 22 21   20   22</span></span>
<span><span class="co"># hp    22  21   20 26   22 21   22 22 22   21   21</span></span>
<span><span class="co"># drat  21  22   21 22   26 20   21 22 22   22   21</span></span>
<span><span class="co"># wt    21  22   20 21   20 26   21 20 22   20   20</span></span>
<span><span class="co"># qsec  20  22   20 22   21 21   26 20 21   22   22</span></span>
<span><span class="co"># vs    22  20   22 22   22 20   20 26 21   20   21</span></span>
<span><span class="co"># am    21  20   21 22   22 22   21 21 26   20   20</span></span>
<span><span class="co"># gear  20  23   20 21   22 20   22 20 20   26   23</span></span>
<span><span class="co"># carb  20  21   22 21   21 20   22 21 20   23   26</span></span></code></pre></div>
<p>Now with the above tips we can optimize this as follows:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwnobs_list_opt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fnobs.html">fnobs.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">nr</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">miss</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">N.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu">pwnobs_list</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span>, <span class="fu">pwnobs_list_opt</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu">pwnobs_list</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span>, <span class="fu">pwnobs_list_opt</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                    expr     min       lq      mean   median       uq     max neval</span></span>
<span><span class="co">#      pwnobs_list(mtcNA) 149.978 152.4585 155.44371 153.8115 157.2965 193.479   100</span></span>
<span><span class="co">#  pwnobs_list_opt(mtcNA)  26.527  27.4495  28.97839  28.0645  29.3560  44.321   100</span></span></code></pre></div>
<p>As the benchmark shows, the optimized function is 6x faster on this
(small) dataset, and we have changed nothing to the loop doing the
computation. With larger data the difference would of course become less
stark, but you never know what’s going on in methods you have not
written and how they behave with larger data. My advice is: avoid them,
use simple objects and take full control over your code. This also makes
your code more robust and you can create class-agnostic code.</p>
<!--
As another illustration let's say we want to aggregate an input-output table:


```r
IOT <- matrix(1, 260, 260)
nam <- as.vector(t(outer(LETTERS, 1:10, paste, sep = ".")))
dimnames(IOT) <- list(nam, nam)
IOT[1:11, 1:11]
#      A.1 A.2 A.3 A.4 A.5 A.6 A.7 A.8 A.9 A.10 B.1
# A.1    1   1   1   1   1   1   1   1   1    1   1
# A.2    1   1   1   1   1   1   1   1   1    1   1
# A.3    1   1   1   1   1   1   1   1   1    1   1
# A.4    1   1   1   1   1   1   1   1   1    1   1
# A.5    1   1   1   1   1   1   1   1   1    1   1
# A.6    1   1   1   1   1   1   1   1   1    1   1
# A.7    1   1   1   1   1   1   1   1   1    1   1
# A.8    1   1   1   1   1   1   1   1   1    1   1
# A.9    1   1   1   1   1   1   1   1   1    1   1
# A.10   1   1   1   1   1   1   1   1   1    1   1
# B.1    1   1   1   1   1   1   1   1   1    1   1

IOT_DF <- qDF(IOT, row.names.col = "country_sector")
head(IOT_DF, 3)
#   country_sector A.1 A.2 A.3 A.4 A.5 A.6 A.7 A.8 A.9 A.10 B.1 B.2 B.3 B.4 B.5 B.6 B.7 B.8 B.9 B.10
# 1            A.1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1
# 2            A.2   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1
# 3            A.3   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1
#   C.1 C.2 C.3 C.4 C.5 C.6 C.7 C.8 C.9 C.10 D.1 D.2 D.3 D.4 D.5 D.6 D.7 D.8 D.9 D.10 E.1 E.2 E.3 E.4
# 1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1
# 2   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1
# 3   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1
#   E.5 E.6 E.7 E.8 E.9 E.10 F.1 F.2 F.3 F.4 F.5 F.6 F.7 F.8 F.9 F.10 G.1 G.2 G.3 G.4 G.5 G.6 G.7 G.8
# 1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1
# 2   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1
# 3   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1
#   G.9 G.10 H.1 H.2 H.3 H.4 H.5 H.6 H.7 H.8 H.9 H.10 I.1 I.2 I.3 I.4 I.5 I.6 I.7 I.8 I.9 I.10 J.1
# 1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1
# 2   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1
# 3   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1
#   J.2 J.3 J.4 J.5 J.6 J.7 J.8 J.9 J.10 K.1 K.2 K.3 K.4 K.5 K.6 K.7 K.8 K.9 K.10 L.1 L.2 L.3 L.4 L.5
# 1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1
# 2   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1
# 3   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1
#   L.6 L.7 L.8 L.9 L.10 M.1 M.2 M.3 M.4 M.5 M.6 M.7 M.8 M.9 M.10 N.1 N.2 N.3 N.4 N.5 N.6 N.7 N.8 N.9
# 1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1
# 2   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1
# 3   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1
#   N.10 O.1 O.2 O.3 O.4 O.5 O.6 O.7 O.8 O.9 O.10 P.1 P.2 P.3 P.4 P.5 P.6 P.7 P.8 P.9 P.10 Q.1 Q.2
# 1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1
# 2    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1
# 3    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1
#   Q.3 Q.4 Q.5 Q.6 Q.7 Q.8 Q.9 Q.10 R.1 R.2 R.3 R.4 R.5 R.6 R.7 R.8 R.9 R.10 S.1 S.2 S.3 S.4 S.5 S.6
# 1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1
# 2   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1
# 3   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1
#   S.7 S.8 S.9 S.10 T.1 T.2 T.3 T.4 T.5 T.6 T.7 T.8 T.9 T.10 U.1 U.2 U.3 U.4 U.5 U.6 U.7 U.8 U.9
# 1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1
# 2   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1
# 3   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1
#   U.10 V.1 V.2 V.3 V.4 V.5 V.6 V.7 V.8 V.9 V.10 W.1 W.2 W.3 W.4 W.5 W.6 W.7 W.8 W.9 W.10 X.1 X.2
# 1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1
# 2    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1
# 3    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1
#   X.3 X.4 X.5 X.6 X.7 X.8 X.9 X.10 Y.1 Y.2 Y.3 Y.4 Y.5 Y.6 Y.7 Y.8 Y.9 Y.10 Z.1 Z.2 Z.3 Z.4 Z.5 Z.6
# 1   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1
# 2   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1
# 3   1   1   1   1   1   1   1    1   1   1   1   1   1   1   1   1   1    1   1   1   1   1   1   1
#   Z.7 Z.8 Z.9 Z.10
# 1   1   1   1    1
# 2   1   1   1    1
# 3   1   1   1    1
```

We can aggregate this as a matrix or data.frame using *collapse* and `data.table::transpose()`:


```r

agg_IOT_DF <- function(IOT_DF) {
  IOT_DF |>
    fmutate(country = substr(country_sector, 1, 1)) |>
    fgroup_by(country) |>
    num_vars() |> fsum() |>
    transpose(keep.names = "country_sector", make.names = "country") |>
    fmutate(country = substr(country_sector, 1, 1)) |>
    fgroup_by(country) |>
    num_vars() |> fsum() |>
    transpose(keep.names = "country", make.names = "country")
}

agg_IOT <- function(IOT) {
  f <- qF(substr(dimnames(IOT)[[1L]], 1, 1), na.exclude = FALSE)
  IOT |> fsum(f) |> t() |> fsum(f) |> t()
}

identical(qM(agg_IOT_DF(IOT_DF), 1), agg_IOT(IOT))
# [1] TRUE
microbenchmark::microbenchmark(agg_IOT_DF(IOT_DF), agg_IOT(IOT))
# Unit: microseconds
#                expr     min       lq     mean   median       uq      max neval
#  agg_IOT_DF(IOT_DF) 521.971 531.6470 568.8795 540.6875 549.6255 2982.873   100
#        agg_IOT(IOT) 364.449 378.0815 402.2805 380.3775 385.2975 2340.280   100
```
-->
<p>When doing this, avoid <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code> and friends to
coerce/recreate data frame-like objects. It is quite easy to construct a
<em>data.frame</em> from a list:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">l</span>, <span class="st">"row.names"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.set_row_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"data.frame"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">l</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co"># 1  21   6  160 110  3.9 2.620 16.46  0  1    4    4</span></span>
<span><span class="co"># 2  21   6  160 110  3.9 2.875 17.02  0  1    4    4</span></span></code></pre></div>
<p>You can also use <em>collapse</em> functions <code><a href="../reference/quick-conversion.html">qDF()</a></code>,
<code><a href="../reference/quick-conversion.html">qDT()</a></code> and <code><a href="../reference/quick-conversion.html">qTBL()</a></code> to efficiently convert/create
<em>data.frame</em>’s, <em>data.table</em>’s, and <em>tibble</em>’s:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>,</span>
<span>                               <span class="fu"><a href="../reference/quick-conversion.html">qTBL</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                   expr    min     lq     mean  median      uq     max neval</span></span>
<span><span class="co">#            qDT(mtcars)  2.952  3.280  3.68467  3.6285  3.7925  16.359   100</span></span>
<span><span class="co">#  as.data.table(mtcars) 34.030 34.809 36.19029 35.3420 36.2235  87.453   100</span></span>
<span><span class="co">#           qTBL(mtcars)  2.378  2.624  2.85196  2.8700  2.9930   5.371   100</span></span>
<span><span class="co">#      as_tibble(mtcars) 48.954 50.225 52.91050 50.7990 51.6600 180.318   100</span></span>
<span></span>
<span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDF</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#              expr     min       lq      mean   median       uq     max neval</span></span>
<span><span class="co">#            qDF(l)   1.681   2.0090   2.26812   2.2550   2.4600   7.093   100</span></span>
<span><span class="co">#  as.data.frame(l) 212.052 218.0175 223.03795 220.5185 224.1060 334.109   100</span></span>
<span><span class="co">#  as.data.table(l)  69.946  73.2055  76.26943  75.0095  76.9365 156.415   100</span></span>
<span><span class="co">#      as_tibble(l)  55.924  59.2245  62.55329  61.2130  63.5090 135.587   100</span></span></code></pre></div>
<p><em>collapse</em> also provides functions like
<code><a href="../reference/small-helpers.html">setattrib()</a></code>, <code><a href="../reference/small-helpers.html">copyMostAttrib()</a></code>, etc., to
efficiently attach attributes again. So another efficient workflow for
general data frame-like objects is to save the attributes
<code>ax &lt;- attributes(data)</code>, manipulate it as a list
<code>l &lt;- unclass(data)</code>, modify <code>ax$names</code> and
<code>ax$row.names</code> as needed and then use
<code>setattrib(l, ax)</code> to turn it into a <em>data.frame</em>
again before returning. This way your code will also work with
<em>tibble</em> etc.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><em>collapse</em> can become a game-changer for your statistical
software development in R, enabling you to write programs that
effectively run like C while accomplishing complex statistical/data
tasks with few lines of code. This however requires taking a closer look
at the package, in particular the <a href="https://sebkrantz.github.io/collapse/reference/collapse-documentation.html">documentation</a>,
and following the three points given in this vignette.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
